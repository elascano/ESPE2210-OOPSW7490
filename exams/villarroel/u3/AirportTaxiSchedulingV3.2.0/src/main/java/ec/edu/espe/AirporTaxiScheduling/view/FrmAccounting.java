package ec.edu.espe.AirporTaxiScheduling.view;

import ec.edu.espe.AirporTaxiScheduling.controller.TraveldbController;
import ec.edu.espe.AirporTaxiScheduling.model.Travel;
import ec.edu.espe.AirporTaxiScheduling.model.TravelerPayment;
import ec.edu.espe.AirporTaxiScheduling.controller.AccountingController;
import java.awt.print.PrinterException;
import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Collections;
import javax.swing.JTable;
import javax.swing.RowSorter;
import javax.swing.SortOrder;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableModel;
import javax.swing.table.TableRowSorter;

/**
 *
 * @author Leonardo Yaranga,Progress Team, DCCO-ESPE
 */
public class FrmAccounting extends javax.swing.JFrame {

    TravelerPayment travelerPayment = new TravelerPayment();
    TraveldbController dataBaseManager = new TraveldbController();

    String collectionName = "Travels";

    /**
     * Creates new form frmAccounting
     */
    public FrmAccounting() {
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
          // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
          private void initComponents() {

                    pnlAccounting = new javax.swing.JPanel();
                    btnBack = new javax.swing.JButton();
                    jLabel1 = new javax.swing.JLabel();
                    jScrollPane3 = new javax.swing.JScrollPane();
                    jtblTravels = new javax.swing.JTable();
                    btnWiewTravels = new javax.swing.JButton();
                    jLabel2 = new javax.swing.JLabel();
                    txtTotalPayed = new javax.swing.JTextField();
                    jLabel3 = new javax.swing.JLabel();
                    txtOutstanding = new javax.swing.JTextField();
                    btmCreatePDF = new javax.swing.JButton();
                    jLabel4 = new javax.swing.JLabel();
                    txtflostPercent = new javax.swing.JTextField();
                    jLabel5 = new javax.swing.JLabel();

                    setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
                    setResizable(false);

                    btnBack.setText("<REGRESAR");
                    btnBack.addActionListener(new java.awt.event.ActionListener() {
                              public void actionPerformed(java.awt.event.ActionEvent evt) {
                                        btnBackActionPerformed(evt);
                              }
                    });

                    jLabel1.setText("CONTABILIDAD");

                    jtblTravels.setModel(new javax.swing.table.DefaultTableModel(
                              new Object [][] {
                                        {null, null, null, null, null, null, null},
                                        {null, null, null, null, null, null, null},
                                        {null, null, null, null, null, null, null},
                                        {null, null, null, null, null, null, null}
                              },
                              new String [] {
                                        "Id", "Conductor", "Pasajero", "Direccion", "Fecha", "Precio", "Pagado"
                              }
                    ));
                    jtblTravels.addMouseListener(new java.awt.event.MouseAdapter() {
                              public void mouseClicked(java.awt.event.MouseEvent evt) {
                                        jtblTravelsMouseClicked(evt);
                              }
                    });
                    jScrollPane3.setViewportView(jtblTravels);

                    btnWiewTravels.setText("Ver las carreras existentes");
                    btnWiewTravels.addActionListener(new java.awt.event.ActionListener() {
                              public void actionPerformed(java.awt.event.ActionEvent evt) {
                                        btnWiewTravelsActionPerformed(evt);
                              }
                    });

                    jLabel2.setText("Total de dinero cobrado:");

                    txtTotalPayed.setEditable(false);
                    txtTotalPayed.addActionListener(new java.awt.event.ActionListener() {
                              public void actionPerformed(java.awt.event.ActionEvent evt) {
                                        txtTotalPayedActionPerformed(evt);
                              }
                    });

                    jLabel3.setText("Saldo pendiente a cobrar: ");

                    txtOutstanding.setEditable(false);
                    txtOutstanding.addActionListener(new java.awt.event.ActionListener() {
                              public void actionPerformed(java.awt.event.ActionEvent evt) {
                                        txtOutstandingActionPerformed(evt);
                              }
                    });

                    btmCreatePDF.setText("Crear PDF");
                    btmCreatePDF.setEnabled(false);
                    btmCreatePDF.addActionListener(new java.awt.event.ActionListener() {
                              public void actionPerformed(java.awt.event.ActionEvent evt) {
                                        btmCreatePDFActionPerformed(evt);
                              }
                    });

                    jLabel4.setText("Porcentaje perdido");

                    jLabel5.setText("%");

                    javax.swing.GroupLayout pnlAccountingLayout = new javax.swing.GroupLayout(pnlAccounting);
                    pnlAccounting.setLayout(pnlAccountingLayout);
                    pnlAccountingLayout.setHorizontalGroup(
                              pnlAccountingLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                              .addGroup(pnlAccountingLayout.createSequentialGroup()
                                        .addGroup(pnlAccountingLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                                  .addGroup(pnlAccountingLayout.createSequentialGroup()
                                                            .addGap(25, 25, 25)
                                                            .addComponent(btnBack)
                                                            .addGap(189, 189, 189)
                                                            .addComponent(jLabel1))
                                                  .addGroup(pnlAccountingLayout.createSequentialGroup()
                                                            .addGap(64, 64, 64)
                                                            .addGroup(pnlAccountingLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                                                      .addComponent(btnWiewTravels)
                                                                      .addGroup(pnlAccountingLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                                                                                .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 550, javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                                .addGroup(javax.swing.GroupLayout.Alignment.LEADING, pnlAccountingLayout.createSequentialGroup()
                                                                                          .addComponent(jLabel2)
                                                                                          .addGap(20, 20, 20)
                                                                                          .addComponent(txtTotalPayed, javax.swing.GroupLayout.PREFERRED_SIZE, 96, javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                                          .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                                                                          .addComponent(btmCreatePDF, javax.swing.GroupLayout.PREFERRED_SIZE, 93, javax.swing.GroupLayout.PREFERRED_SIZE))
                                                                                .addGroup(javax.swing.GroupLayout.Alignment.LEADING, pnlAccountingLayout.createSequentialGroup()
                                                                                          .addGroup(pnlAccountingLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                                                                                    .addComponent(jLabel3)
                                                                                                    .addComponent(jLabel4))
                                                                                          .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                                                                          .addGroup(pnlAccountingLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                                                                                    .addComponent(txtOutstanding, javax.swing.GroupLayout.PREFERRED_SIZE, 96, javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                                                    .addGroup(pnlAccountingLayout.createSequentialGroup()
                                                                                                              .addComponent(txtflostPercent, javax.swing.GroupLayout.PREFERRED_SIZE, 77, javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                                                              .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                                                                                              .addComponent(jLabel5))))))))
                                        .addContainerGap(65, Short.MAX_VALUE))
                    );
                    pnlAccountingLayout.setVerticalGroup(
                              pnlAccountingLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                              .addGroup(pnlAccountingLayout.createSequentialGroup()
                                        .addGap(33, 33, 33)
                                        .addGroup(pnlAccountingLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                                  .addComponent(btnBack)
                                                  .addComponent(jLabel1))
                                        .addGap(61, 61, 61)
                                        .addComponent(btnWiewTravels)
                                        .addGap(18, 18, 18)
                                        .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 139, javax.swing.GroupLayout.PREFERRED_SIZE)
                                        .addGap(33, 33, 33)
                                        .addGroup(pnlAccountingLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                                  .addComponent(jLabel2)
                                                  .addComponent(txtTotalPayed, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 36, Short.MAX_VALUE)
                                        .addGroup(pnlAccountingLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                                  .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnlAccountingLayout.createSequentialGroup()
                                                            .addComponent(btmCreatePDF, javax.swing.GroupLayout.PREFERRED_SIZE, 31, javax.swing.GroupLayout.PREFERRED_SIZE)
                                                            .addGap(55, 55, 55))
                                                  .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnlAccountingLayout.createSequentialGroup()
                                                            .addGroup(pnlAccountingLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                                                      .addComponent(jLabel3)
                                                                      .addComponent(txtOutstanding, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                                                            .addGap(29, 29, 29)
                                                            .addGroup(pnlAccountingLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                                                      .addComponent(jLabel4)
                                                                      .addComponent(txtflostPercent, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                      .addComponent(jLabel5))
                                                            .addGap(23, 23, 23))))
                    );

                    javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
                    getContentPane().setLayout(layout);
                    layout.setHorizontalGroup(
                              layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                              .addComponent(pnlAccounting, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    );
                    layout.setVerticalGroup(
                              layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                              .addComponent(pnlAccounting, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    );

                    pack();
                    setLocationRelativeTo(null);
          }// </editor-fold>//GEN-END:initComponents

    private void btnBackActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnBackActionPerformed
        AirportTaxiScheduling airportTaxiScheduling;
        airportTaxiScheduling = new AirportTaxiScheduling();
        this.setVisible(false);
        airportTaxiScheduling.setVisible(true);
    }//GEN-LAST:event_btnBackActionPerformed

    private void jtblTravelsMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jtblTravelsMouseClicked

    }//GEN-LAST:event_jtblTravelsMouseClicked

    private void btnWiewTravelsActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnWiewTravelsActionPerformed
        btmCreatePDF.setEnabled(true);
        float totalValue;
        float outsBalance;
        float lostPercent;
        ArrayList<Float> payedValues = new ArrayList<Float>();
        ArrayList<Float> outsValues = new ArrayList<Float>();

        dataBaseManager = TraveldbController.connectToDatabase(dataBaseManager);

        ArrayList<Travel> travelsView = new ArrayList<Travel>();
        TraveldbController.load(travelsView, dataBaseManager.getDatabase(), collectionName);
        for (int i = 0; i < travelsView.size(); i++) {

            if (travelsView.get(i).isPayed() == false) {
                outsValues.add((travelsView.get(i).getPrice()));
            }
            if (travelsView.get(i).isPayed() == true) {
                payedValues.add(travelsView.get(i).getPrice());
            }
        }
        totalValue = AccountingController.calculateTotal(payedValues);
        outsBalance = AccountingController.calculateTotal(outsValues);
        lostPercent = AccountingController.calculateLostPercent(totalValue, outsBalance);
        viewTravels();
        txtTotalPayed.setText(Float.toString(totalValue));
        txtOutstanding.setText(Float.toString(outsBalance));
        txtflostPercent.setText(Float.toString(lostPercent));
        TableRowSorter<TableModel> sorter = new TableRowSorter<>(jtblTravels.getModel());
        sorter.setSortKeys(Collections.singletonList(new RowSorter.SortKey(1, SortOrder.ASCENDING)));
        jtblTravels.setRowSorter(sorter);
        jtblTravels.repaint();
    }//GEN-LAST:event_btnWiewTravelsActionPerformed

    private void txtTotalPayedActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtTotalPayedActionPerformed
    }//GEN-LAST:event_txtTotalPayedActionPerformed

    private void txtOutstandingActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtOutstandingActionPerformed
    }//GEN-LAST:event_txtOutstandingActionPerformed

    private void btmCreatePDFActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btmCreatePDFActionPerformed
        MessageFormat header = new MessageFormat("Accouting of travels");
        MessageFormat footer = new MessageFormat(" Total: " + txtTotalPayed.getText() + " Outstanding Balance: " + txtOutstanding.getText() + " page {0,number,integer}");

        try {
            jtblTravels.print(JTable.PrintMode.FIT_WIDTH, header, footer);
        } catch (PrinterException e) {
            e.getMessage();
        }
    }//GEN-LAST:event_btmCreatePDFActionPerformed

    private void viewTravels() {
        cleanForm();
        dataBaseManager = TraveldbController.connectToDatabase(dataBaseManager);
        ArrayList<Travel> travelsView = new ArrayList<Travel>();
        String[] titles = {"Id", "Conductor", "Pasajero", "Direccion", "Fecha", "Precio", "Pagado"};
        String[] travelsString = new String[7];
        DefaultTableModel tableOfTravels = new DefaultTableModel(null, titles);
        TraveldbController.load(travelsView, dataBaseManager.getDatabase(), collectionName);

        for (int i = 0; i < travelsView.size(); i++) {
            travelsString[0] = "" + travelsView.get(i).getId() + "";
            travelsString[1] = "" + travelsView.get(i).getDriver() + "";
            travelsString[2] = "" + travelsView.get(i).getTraveler() + "";
            travelsString[3] = "" + travelsView.get(i).getAddress() + "";
            travelsString[4] = "" + travelsView.get(i).getDateOfOcurrence() + "";
            travelsString[5] = "" + travelsView.get(i).getPrice() + "";
            travelsString[6] = "" + String.valueOf(travelsView.get(i).isPayed()) + "";
            tableOfTravels.addRow(travelsString);

        }

        jtblTravels.setModel(tableOfTravels);
        jtblTravels.setDefaultEditor(Object.class, null);

    }

    private void cleanForm() {
        DefaultTableModel tableOfTravels = new DefaultTableModel();
        jtblTravels.setModel(tableOfTravels);
    }

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                new FrmAccounting().setVisible(true);
            }
        });
    }

          // Variables declaration - do not modify//GEN-BEGIN:variables
          private javax.swing.JButton btmCreatePDF;
          private javax.swing.JButton btnBack;
          private javax.swing.JButton btnWiewTravels;
          private javax.swing.JLabel jLabel1;
          private javax.swing.JLabel jLabel2;
          private javax.swing.JLabel jLabel3;
          private javax.swing.JLabel jLabel4;
          private javax.swing.JLabel jLabel5;
          private javax.swing.JScrollPane jScrollPane3;
          private javax.swing.JTable jtblTravels;
          private javax.swing.JPanel pnlAccounting;
          private javax.swing.JTextField txtOutstanding;
          private javax.swing.JTextField txtTotalPayed;
          private javax.swing.JTextField txtflostPercent;
          // End of variables declaration//GEN-END:variables
}
